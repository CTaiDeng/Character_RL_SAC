# 字符模式 SAC 的工程实现与数学化描述（v2.0.0）

作者：项目工程组  •  版本：v2.0.0  •  说明：修复“仅用两字符匹配”的局限，改为遍历长度集合 U

摘要
- 本版在不改变总体 SAC 框架的前提下，将“前缀/后缀命中”的固定两字符限制推广为“遍历 data/word_length_sets.json 提供的长度集合 U”的可变长度匹配；以“最长可用命中”为停表准则，统一 raw_action 与 bigram 的拓扑规则。
- 该修复显著提升中文词法对齐与奖励密度，降低字符级训练中的信用分配难度，并改善 OOV/长词边界的泛化。

关键词：中文知识蒸馏；可变长度后缀；最长可用命中；SAC；字符级策略

## 1 变更动机
- v1.0.0 局限：前缀与后缀命中均默认使用“两字符”作为判定窗口，无法适配多字词（如“面红耳赤”“如今”“未来”等）对齐，导致早停或错停。
- v2.0.0 改进：从 `data/word_length_sets.json` 读取并集长度集合 U（如 U={2,3,4,5,6,7,8,9,10,11,13}），在匹配时按降序遍历 U∩[1..当前长度]，以“最长可用命中”为停表准则，前缀与后缀逻辑一致。

## 2 形式化定义
- 词表并集（只读）：
  - 𝒞 = Catalog = chinese_name_frequency_word.json ∪ chinese_frequency_word.json。
- 允许长度集合：
  - U = union.lengths ⊂ ℕ，由 `data/word_length_sets.json` 读取；示例：U = {2,3,4,5,6,7,8,9,10,11,13}。
- 目标字符：χ_t；上一摘要预览：prev_t（取末尾≤1字用于观测与渲染）。
- 源串：source_t = prev_t ⊕ χ_t。

记运算 tail(s, L) 为串 s 的后缀，len(s) 为长度，is_cjk(s) 判定全为中日韩统一表意字符。

## 3 可变长度“前缀命中”（历史左扩）
目标：使 source_t 的“前缀命中”成立：

$$
\exists L \in U \cap [1..\lvert\mathrm{source}_t\rvert],\ \mathrm{prefix}(\mathrm{source}_t, L) \in \mathcal{C}.
$$

若不成立，则沿历史字符对向左扩展 prev_t，至多 N 步（N = character_history_extension_limit，默认 16），每步尝试最新的 source_t 是否满足上式，并取“最长 L”命中：

```pseudo
function EXTEND_PREV_FOR_PREFIX_HIT(prev, chapter, history_pairs, N, U):
    source = prev + chapter
    if len(source) < 1: return prev
    step = 0
    while not ANY_PREFIX_HIT(source, U) and step < N and history_pairs.has_left(step):
        pair = history_pairs.left(step)     # pair.head + pair.tail，tail 与 prev 对齐
        if prev and not prev.startswith(pair.tail):
            step += 1; continue
        prev = pair.head + prev
        source = prev + chapter
        step += 1
    return prev

function ANY_PREFIX_HIT(source, U):
    Ls = sort_desc(U ∩ {1..len(source)})
    for L in Ls:
        seg = source[:L]
        if is_cjk(seg) and seg in 𝒞: return True
    return False
```

注：v1.0.0 的“两字符前缀”相当于固定 U={2} 的特例；本版改为通用 U。

## 4 可变长度“后缀命中”（raw_action 与 bigram）
### 4.1 raw_action 的后缀拓扑
以策略首字 c 为起点，拼接未来真值字符形成 q；遇“后缀命中”即停，优先最长 L：

$$
\exists L \in U \cap [1..\lvert q\rvert],\ \mathrm{tail}(q, L) \in \mathcal{C}.
$$

```pseudo
function EXTEND_RAW_ACTION_SUFFIX(c, future_chars, U):
    q = dedup_head_repeat(c)   # 处理首字重复，如“辑辑…”→“辑…”
    for ch in future_chars:
        q += ch
        for L in sort_desc(U ∩ {1..len(q)}):
            seg = tail(q, L)
            if is_cjk(seg) and seg in 𝒞:
                return q, seg, annotate(seg)   # 命中即停（最长优先）
    # 未命中时回退到最长连续 CJK 尾段，便于日志显示
    return q, longest_cjk_tail(q, max(U)), annotate_optional()
```

### 4.2 bigram 的前向拓扑
以 s = χ_t ⊕ q 为基串，同样在 U 上做“后缀命中”，命中即停；用于 bigram 奖励与注记：

```pseudo
function FORWARD_EXTEND_BIGRAM(chapter, q, future_chars, U):
    s = chapter + q
    best2 = tail(s, min(2, len(s)))         # 仅用于未命中回退显示
    for ch in future_chars:
        s += ch
        for L in sort_desc(U ∩ {1..len(s)}):
            seg = tail(s, L)
            if is_cjk(seg) and in_catalog(seg):
                return seg, s
    return best2, s
```

## 5 奖励构成（与 v1.0.0 兼容）
- 质量/词法/洁净度分量维持不变：

$$
\mathcal{N}_\gamma(x)=1-(1-x)^\gamma,\quad S_t=Q_t+L_t-P_t.
$$

- 字符模式加成保留，但“命中”由 U 上的可变长度后缀决定：

$$
\delta_t=\begin{cases}
1.0,&\exists L\in U,\ \mathrm{tail}(s,L)\in\mathcal{C},\\
0.5,&\mathrm{tail}(s,1)=\text{target\_char},\\
0,&\text{otherwise}.
\end{cases}
$$

$$
B_t^{\text{char}}=B_t+0.5\,\chi_t^{\text{soft}}+\delta_t,\quad
\Delta_t^{\text{char}}=\Delta_t+0.25\,\chi_t^{\text{soft}}.
$$

## 6 复杂度与实现考量
- 每次命中判定的时间复杂度：O(|U|)，实际 |U|≈10–12；配合缓存可控。
- 历史左扩最坏 O(N)，N=character_history_extension_limit（默认 16）。
- 与 v1.0.0 相比，开销从“常数 2”变为“集合 U 的长度”，但带来显著的命中率和对齐质量提升。

## 7 与 v1.0.0 差异清单
- 前缀命中：由“固定两字”→“U 上最长前缀命中”。
- raw_action 后缀：由“固定两字”→“U 上最长后缀命中，命中即停”。
- bigram 后缀：同 raw_action，复用 U。
- 日志注记：显示命中词及来源（如 data/chinese_frequency_word.json#236703），并可显示命中长度 L。
- 失败回退：保留“last‑2 展示”仅用于可读性，不再作为命中判据。

## 8 兼容性与落地
- 配置项不变：`character_history_extension_limit` 仍为 16；仅匹配逻辑改为使用 U。
- 数据依赖：`data/word_length_sets.json` 必须存在且包含 union.lengths；缺失时建议回退 U=\{2..8\} 并记录告警。
- 与知识蒸馏关系：U 来自真实语料词长分布，将“词级先验”蒸馏到字符级策略，提升样本效率与稳定性。

## 9 评测建议
- 消融：固定 U={2} vs. U=union.lengths；对比收敛速度、最终 reward、词法命中率。
- 命中统计：平均命中长度、命中率（前缀/后缀分别统计）。
- 泛化：跨域/OOV 文本上的表现差异，长词边界识别能力。

附录：记号
- 𝒞：词表并集；U：长度集合；χ_t：目标字符；prev_t：摘要预览；source_t：源串；q：raw_action 串；s：bigram 串；
- tail(s,L)：后缀；prefix(s,L)：前缀；N：历史左扩上限；is_cjk(·)：CJK 判定。

