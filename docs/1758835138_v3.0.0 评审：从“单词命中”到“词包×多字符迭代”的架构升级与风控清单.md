# v3.0.0 评审：从“单词命中”到“词包×多字符迭代”的架构升级与风控清单

---

## 结论（Executive Summary）

* **正向增值**：v3.0.0 把**向前拓扑**从“单词”升级为“**拓扑词包命中**”、把**向后拓扑**从“1 字 bigram”升级为“**多字符迭代预测**”。两类能力均以**算子化接口**接入合规模块与奖励记录，扩展性与可审计性明显增强。
* **P0 风险**：多字符迭代若作为“单步动作外的内部生成”，会破坏**逐字一步（MDP 闭合）**假设；词包命中若放开到**substring**作用域，容易放大**假阳性**与**奖励投机**。
* **上线判断**：建议**灰度放量（10–20%）**，默认“**tail 作用域 + K_max≤L_p + 语义门控 + IDF/二字降权 + 单字禁奖**”，并把多字符迭代收口为**宏动作（Option）**以守住 MDP 闭合。

---

## 亮点（已成立的工程价值）

1. **词法表达力↑**：词包（含别名、专有短语、顺序敏感）覆盖 v2 未能稳定捕获的长词/搭配（医疗、法务、RAG 场景明确受益）。
2. **奖励密度↑**：多字符迭代把“命中机会”提前到更短地平线，信用分配更局部，训练方差预计下降。
3. **治理可用↑**：算子化 + 配置化 + 新日志字段（`topo_pack_id/iter_k`）→ 可回放、可问责、可回滚。

---

## P0 必改（上线前必须收口）

1. **MDP 闭合/宏动作建模**

   * 将“多字符迭代算子”定义为**Option/Macro-Action**：(\mathcal O=(I,\pi_{\text{intra}},\beta))，一外步触发，内部最多 (K_{\max}) 子步，**终止信号=命中或封顶**。
   * 计费与奖励：把内部子步的**长度成本**与**命中增益**折算为**同一外步**的回报；日志保留子步轨迹但**训练仍逐外步更新**。
   * 把 (K_{\max})**不大于**当前 (L_p)，保持与 Flex-Attn 资源治理一致。

2. **默认只开 tail 作用域**

   * `scope="tail"` 为生产默认；`substring` 仅用于离线实验或特定域白名单，且需**窗口限制**（例如尾部 ±W）。
   * 任何非尾部命中必须过**语义门控（sim>τ）**与**IDF/二字降权**。

3. **权重与去投机**

   * 词包命中得分 (\delta_t=\lambda_{\text{lex}}\cdot \text{pack_w}(P)\cdot \mathbf 1[\text{hit}]\cdot \max(0,\mathrm{sim}-\tau)\cdot \mathrm{idf})。
   * **单字禁奖**、**二字降权**固化；同一 pack 连续命中**去重或衰减**（防“连环刷分”）。
   * 词包内短语重叠时**最长优先**，同长按 pack_w 与 IDF 决胜。

4. **索引结构**

   * 词包预编译为**反向 Trie / Aho-Corasick（AC）** + 规范化字典（大小写/全半角/别名）；
   * AC 状态缓存到步级上下文，保证均摊近 (O(1))。

---

## P1 优化（两周内纳入）

* **Option-Critic/HiRL** 记账：在日志中显式记录宏动作**起止索引、内部子步数、终止因子**，便于离线 credit assignment 分析。
* **带权 KAT 对位**：词包命中视为 KAT test 的**带权版本**（Semiring：Log-Viterbi，(\oplus=\max,\ \otimes=+)），把“最长可用命中=最大权命中”形式化。
* **冲突消解**：当 Catalog 与词包同时命中，统一走“**最长优先 → pack_w → IDF → 词典顺序**”，并写入日志。
* **异常与安全**：词包上线走**静态审计**（黑词/敏感词/误触发样本库），并配置**杀开关**（packs 全局禁用）。

---

## 与 v1/v2 的兼容与回滚

* 兼容：`enabled=false` 即回落到 v2；`k_max=2, stop_on_hit=true` 近似 v2 bigram；`packs_path` 为空即回退到 Catalog 单词命中。
* 回滚：**双缓冲**与**金丝雀**（10–20%）→ KPI 守门 → 全量；任何 KPI 越界自动滚回上一版本包与配置。

---

## 复杂度与资源评估

* **时间**：tail 作用域 + AC 均摊近 (O(1))；substring 作用域为 (O(|\text{sub}(s,U)|\cdot \bar{k}))，不建议在高 QPS 场景开启。
* **内存**：词包 AC 自动机 + 规范化映射表预计增量 **几十 MB 量级**（与 packs 规模线性）。
* **吞吐**：推荐将词包匹配放入**独立 worker** 或 **C 扩展/内核**，并缓存最近 AC 状态。

---

## 合规/奖励接口（建议落盘）

* **合规模块**：`_mask_logits` 仍仅决定合法字符；新增的命中 **只作为诊断信号** 与奖励塑形，不改变掩码边界。
* **奖励日志（新增字段）**：

  * `lexical_topo_bonus`（数值）、`topo_hit_phrase`（string）、`topo_pack_id`（string）、`topo_hit_len`（int）、`iter_k`（int）、`option_duration`（内部子步）
  * 统一写入 JSONL，保证**100% 回放**。

---

## 评测与验收（强口径）

* **语义**：BERTScore/ROUGE-L **不劣化或上升**（p<0.01）。
* **词法**：`word_noncompliance` **↓≥30%**；**术语/短语覆盖** **+8–15pp**。
* **稳定**：收敛步数 **↓≥15%**，多次训练**方差 ↓≥20%**。
* **产线**：P95 延迟/QPS 在 SLA 内；词包匹配 CPU 占比 <10%；回放/回滚成功率 **100%**。

---

## 风险与对策（表）

| 风险     | 触发机制                 | 对策                                          | 监控                            |
| ------ | -------------------- | ------------------------------------------- | ----------------------------- |
| MDP 破坏 | 多字符迭代被当作“多步写入”       | 宏动作（Option）建模；外步计费与奖励折算                     | 记录 `option_duration` 与外步一致性   |
| 奖励投机   | substring 命中/高频短词刷分  | 默认 tail；门控 τ + IDF/二字降权 + 单字禁奖；同 pack 去重/衰减 | 观察 `topo_hit_len` 与高频命中 Top-K |
| 复杂度飙升  | packs 大、substring 开启 | AC 编译 + 状态缓存；对 substring 加窗口                | tok/s 与 CPU 占比面板              |
| 词包污染   | 低质/歧义词条上线            | 静态审计 + 黑词表 + 杀开关                            | 异常样本工单与命中回放                   |
| 冲突/歧义  | Catalog 与 pack 重叠    | 最长优先→pack_w→IDF；日志落盘                        | 冲突样本计数                        |

---

## 建议的默认配置（安全基线）

```json
{
  "forward_pack_match": {
    "enabled": true,
    "scope": "tail",
    "packs_path": "data/topology_word_packs.json",
    "normalize": { "alias": true, "casefold": true, "fullwidth": true }
  },
  "backward_iter": {
    "enabled": true,
    "k_max": 3,
    "stop_on_hit": true
  },
  "reward": {
    "ban_single_char": true,
    "downweight_bigram": 0.6,
    "tau_semantic_gate": 0.75,
    "lambda_lex": 0.30
  }
}
```

---

## 一句话收尾

v3.0.0 在**表达力**与**可治理**上迈了一步大台阶，但必须以**宏动作建模守住 MDP**，以**tail 作用域 + 语义门控 + IDF/二字降权**守住“奖励净化”。按本文 P0/P1 收口上线，这次升级可以把**奖励密度、训练稳定性与术语覆盖**三条主线同时推进，并保持**可回放、可回滚、可审计**的产线标准。
