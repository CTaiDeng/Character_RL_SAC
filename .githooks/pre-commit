#!/usr/bin/env bash
set -euo pipefail

# Normalize changed Markdown files, then sync README index

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

PY=python
command -v "$PY" >/dev/null 2>&1 || PY=python3

changed_md=( $(git diff --cached --name-only --diff-filter=ACMRTUXB | grep -E '\.md$' || true) )

if [ ${#changed_md[@]} -gt 0 ]; then
  echo "[pre-commit] 正在规范化 Markdown：${changed_md[*]}"
  "$PY" scripts/md_normalize.py "${changed_md[@]}" || true
fi

echo "[pre-commit] 同步 README 文档摘要索引"
"$PY" scripts/update_readme_index.py || true

# 清理临时文件，避免误提交
rm -f out_prev_readme.txt 2>/dev/null || true

# 重新添加可能被脚本修改的文件
git add README.md || true
if [ ${#changed_md[@]} -gt 0 ]; then
  git add "${changed_md[@]}" || true
fi

exit 0
